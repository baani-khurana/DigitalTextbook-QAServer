{{extend 'layout.html'}}

{{block header_script}}
<script>
    var URL = {
        submitNewDiscussion: '{{=URL("default","submit_new_discussion")}}'
    },
    ENV = {
        pageNum: '{{=page_num}}'
    }

    $(function(){
        // Attach click handlers
        $('#discussionStartBtn').on('click', function(){
            openOverlay('#addDiscussionPopup');
        });

        $('.close').click(function(){
            closeOverlay();
        });

        $('#overlay').click(function(e){
            if($(e.target).is('#overlay')){
                closeOverlay();
            }
        });

        $('#addDiscussionPopup .submit').click(function(){
            submitDiscussion();
        });
    });

    function openOverlay(id){
        var overlay = $('#overlay');
        overlay.show('slow');
        $(id, overlay).show('slow');
    }

    function closeOverlay(){
        var overlay = $('#overlay');
        overlay.hide('slow');
        $('.popup', overlay).hide('slow');
    }

    function submitDiscussion(){
        // Get data
        var popup = $('#addDiscussionPopup');
        // Submit discussion
        var data = {
            title: $('[name=title]',popup).val(),
            description: $('[name=description]',popup).val(),
            page_num: ENV.pageNum
        };
        // Submit
        $.ajax({
            url: URL.submitNewDiscussion,
            method: 'POST',
            data: data,
            success: function(data){
                var id = data;
                window.location.href = "{{=URL('default','discussion')}}?id=" + id;
            }, error: function(data){
                alert(data.responseText);
            }
        });
    }
</script>
{{end}}

<h2>Main concepts in page {{=page_num}}</h2>

<ul class="linkList divisor">
    {{if len(concepts) > 0:}}
        {{for c in concepts:}}
            <li><a class="tag" href="#" style="background: {{=c.color}};">{{=c.name}}</a></li>
        {{pass}}
    {{else:}}
        <li>No concepts exist for this page.</li>
    {{pass}}
</ul>

<h2>
	Discussions for page {{=page_num}}
	<a id="discussionStartBtn" class="button specialButton" href="#" >Start a discussion (+15 points)</a>
</h2>

{{if len(discussions) > 0:}}
<ul class="questionsList"> 
    {{for d in discussions:}}
	<li class="questionLink">
		<p class="question"> {{=d.discussion.title}} 
			<img class="arrow" src="{{=URL('static','images/arrow.png')}}" alt="Question Arrow">
		</p>
		<p class="timeStamp">Asked by {{=d.user_info.name}} | {{=d.discussion.date_added}}</p>
	</li>
    {{pass}}
</ul>
{{else:}}
<div class="questionsPanel">
	<p>
		There are no questions yet for this page. Why not start one? :)
	</p>
</div>
{{pass}}

<div id="overlay">
    <div id="addDiscussionPopup" class="popup">
        <div class="close">
            <img src="{{=URL('static','images/close.png')}}" alt="">
        </div>

        <h2>Add a new discussion</h2>

        <p>
            <h3>Title</h3>
            <input type="text" name="title" placeholder="Suggest a title for your discussion"/>
        </p>

        <p>
            <h3>Description</h3>
            <textarea name="description" placeholder="Enter a longer description of your discussion"></textarea>
        </p>

        <a href="#" class="button submit">Submit discussion</a>
    </div>

</div>
